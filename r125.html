<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<meta name="description" content="Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØµØ­Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª">
<title>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØµØ­Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</title>
<link rel="icon" type="image/png" href="images1/00011.png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --secondary: #06b6d4;
  --accent: #f59e0b;
  --success: #10b981;
  --danger: #ef4444;
  --background: #0f172a;
  --surface: #1e293b;
  --surface-light: #334155;
  --text: #f8fafc;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border: rgba(148, 163, 184, 0.1);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
  --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
  --radius: 12px;
  --radius-sm: 8px;
  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

html {
  font-size: 16px;
  scroll-behavior: smooth;
}

body {
  font-family: 'Tajawal', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--background);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* Header */
.app-header {
  background: linear-gradient(135deg, var(--surface) 0%, var(--background) 100%);
  padding: 20px;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(10px);
}

.main-title {
  text-align: center;
  margin-bottom: 20px;
}

.main-title img {
  max-width: 100%;
  height: auto;
  max-height: 60px;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

/* Stats Bar */
.stats-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
  gap: 10px;
}

.stats-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.95rem;
  color: var(--text-secondary);
}

.stats-value {
  color: var(--primary);
  font-weight: 700;
  font-size: 1.1rem;
}

/* Controls */
.controls {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
}

.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  border: none;
  outline: none;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 12px -1px rgba(59, 130, 246, 0.4);
}

.btn-secondary {
  background: var(--surface-light);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--primary);
  color: white;
}

/* Articles Grid */
.articles-wrapper {
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.articles-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 24px;
}

@media (max-width: 768px) {
  .articles-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
}

/* Article Card */
.article-card {
  background: var(--surface);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow);
  transition: var(--transition);
  cursor: pointer;
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  height: 100%;
}

.article-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
  border-color: var(--primary);
}

.article-image-wrapper {
  position: relative;
  width: 100%;
  height: 220px;
  overflow: hidden;
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
}

.article-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.article-card:hover .article-image {
  transform: scale(1.05);
}

.image-placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-muted);
  font-size: 3rem;
}

/* Badges */
.badges {
  position: absolute;
  top: 12px;
  right: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 6px;
  backdrop-filter: blur(8px);
}

.badge-date {
  background: rgba(239, 68, 68, 0.9);
  color: white;
}

.badge-theme {
  background: rgba(6, 182, 212, 0.9);
  color: white;
}

.badge-lang {
  background: rgba(245, 158, 11, 0.9);
  color: white;
  text-transform: uppercase;
}

.time-ago {
  position: absolute;
  top: 12px;
  left: 12px;
  padding: 6px 12px;
  background: rgba(15, 23, 42, 0.8);
  color: var(--text-secondary);
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: 20px;
  backdrop-filter: blur(8px);
}

/* Article Content */
.article-content {
  padding: 20px;
  flex: 1;
  display: flex;
  flex-direction: column;
}

.article-title {
  font-size: 1.15rem;
  font-weight: 700;
  color: var(--text);
  line-height: 1.5;
  margin-bottom: 12px;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.article-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 12px;
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.meta-item.source {
  color: var(--secondary);
  font-weight: 600;
}

/* Keywords */
.keywords {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: auto;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}

.keyword {
  padding: 4px 10px;
  background: var(--surface-light);
  color: var(--text-secondary);
  font-size: 0.75rem;
  border-radius: 12px;
  transition: var(--transition);
}

.keyword:hover {
  background: var(--primary);
  color: white;
}

/* Sentiment */
.sentiment {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
}

.sentiment-positive {
  background: rgba(16, 185, 129, 0.2);
  color: var(--success);
}

.sentiment-negative {
  background: rgba(239, 68, 68, 0.2);
  color: var(--danger);
}

.sentiment-neutral {
  background: rgba(148, 163, 184, 0.2);
  color: var(--text-secondary);
}

/* Loading */
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.spinner {
  width: 50px;
  height: 50px;
  border: 3px solid var(--surface-light);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Error State */
.error-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.error-icon {
  font-size: 4rem;
  margin-bottom: 20px;
  opacity: 0.5;
}

/* Overlay */
.overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.95);
  z-index: 1000;
  backdrop-filter: blur(10px);
}

.overlay.active {
  display: flex;
  flex-direction: column;
}

.overlay-header {
  padding: 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 16px;
}

.overlay-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text);
  flex: 1;
  line-height: 1.4;
}

.overlay-close {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--danger);
  color: white;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
  flex-shrink: 0;
}

.overlay-close:hover {
  transform: rotate(90deg);
  background: #dc2626;
}

.overlay-body {
  flex: 1;
  overflow: hidden;
  background: white;
}

.overlay-frame {
  width: 100%;
  height: 100%;
  border: none;
}

/* Scroll Top */
.scroll-top {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--primary);
  color: white;
  border: none;
  font-size: 1.25rem;
  cursor: pointer;
  opacity: 0;
  visibility: hidden;
  transition: var(--transition);
  box-shadow: var(--shadow-lg);
  z-index: 99;
  display: flex;
  align-items: center;
  justify-content: center;
}

.scroll-top.visible {
  opacity: 1;
  visibility: visible;
}

.scroll-top:hover {
  transform: translateY(-4px);
  background: var(--primary-dark);
}

/* Print Styles */
@media print {
  .app-header, .stats-bar, .scroll-top, .overlay, .controls {
    display: none !important;
  }
  
  body {
    background: white;
    color: black;
  }
  
  .articles-grid {
    display: block;
  }
  
  .article-card {
    break-inside: avoid;
    margin-bottom: 20px;
    page-break-inside: avoid;
    box-shadow: none;
    border: 1px solid #ddd;
  }
}

/* Mobile Optimizations */
@media (max-width: 480px) {
  .app-header {
    padding: 15px;
  }
  
  .stats-bar {
    padding: 12px 15px;
    font-size: 0.85rem;
  }
  
  .articles-wrapper {
    padding: 12px;
  }
  
  .article-image-wrapper {
    height: 180px;
  }
  
  .article-content {
    padding: 15px;
  }
  
  .article-title {
    font-size: 1rem;
  }
}

/* Animation */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.article-card {
  animation: fadeInUp 0.4s ease forwards;
}
</style>
</head>
<body>
<header class="app-header">
  <div class="main-title">
    <img src="images/title.png" alt="Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØµØ­Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©">
  </div>
  
  <div class="controls">
    <button class="btn btn-primary" id="download-pdf">
      <span>ğŸ“„</span>
      <span>ØªØ­Ù…ÙŠÙ„ PDF</span>
    </button>
    <button class="btn btn-secondary" id="refresh-data">
      <span>ğŸ”„</span>
      <span>ØªØ­Ø¯ÙŠØ«</span>
    </button>
  </div>
</header>

<div class="stats-bar">
  <div class="stats-item">
    <span>ğŸ“Š</span>
    <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª:</span>
    <span class="stats-value" id="total-count">0</span>
  </div>
  <div class="stats-item">
    <span>ğŸ“…</span>
    <span>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</span>
    <span class="stats-value" id="last-update">--</span>
  </div>
</div>

<main class="articles-wrapper">
  <div id="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª...</p>
  </div>
  
  <div id="articles-container" class="articles-grid" style="display: none;"></div>
  
  <div id="error" class="error-state" style="display: none;">
    <div class="error-icon">âš ï¸</div>
    <h3>Ø­Ø¯Ø« Ø®Ø·Ø£</h3>
    <p id="error-message">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
    <button class="btn btn-primary" onclick="loadArticles()" style="margin-top: 20px;">
      Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
    </button>
  </div>
</main>

<button class="scroll-top" id="scroll-top">â†‘</button>

<div class="overlay" id="overlay">
  <div class="overlay-header">
    <div class="overlay-title" id="overlay-title"></div>
    <button class="overlay-close" id="overlay-close">Ã—</button>
  </div>
  <div class="overlay-body">
    <iframe class="overlay-frame" id="overlay-frame" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
  </div>
</div>

<div id="pdf-container" style="display: none;"></div>

<script>
// Configuration
const CONFIG = {
  dataUrl: 'data/data_fusionnee.json?t=' + Date.now(),
  githubBase: 'https://github.com/marocnetmail/125/blob/main/',
  imagesPath: 'images/img05/',
  rawSuffix: '?raw=true'
};

// State
let articles = [];
let currentArticle = null;

// Elements
const elements = {
  loading: document.getElementById('loading'),
  container: document.getElementById('articles-container'),
  error: document.getElementById('error'),
  errorMessage: document.getElementById('error-message'),
  totalCount: document.getElementById('total-count'),
  lastUpdate: document.getElementById('last-update'),
  scrollTop: document.getElementById('scroll-top'),
  overlay: document.getElementById('overlay'),
  overlayTitle: document.getElementById('overlay-title'),
  overlayFrame: document.getElementById('overlay-frame'),
  overlayClose: document.getElementById('overlay-close'),
  downloadBtn: document.getElementById('download-pdf'),
  refreshBtn: document.getElementById('refresh-data'),
  pdfContainer: document.getElementById('pdf-container')
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadArticles();
  setupEventListeners();
});

function setupEventListeners() {
  // Scroll to top
  window.addEventListener('scroll', () => {
    elements.scrollTop.classList.toggle('visible', window.scrollY > 400);
  });
  
  elements.scrollTop.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
  
  // Overlay
  elements.overlayClose.addEventListener('click', closeOverlay);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeOverlay();
  });
  
  // Buttons
  elements.downloadBtn.addEventListener('click', generatePDF);
  elements.refreshBtn.addEventListener('click', loadArticles);
}

async function loadArticles() {
  showLoading();
  
  try {
    const response = await fetch(CONFIG.dataUrl);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();
    
    // Process all articles without filtering
    articles = data
      .filter(a => a.visible !== false && a.visible !== "false" && a.visible !== 0)
      .sort((a, b) => new Date(b.date_heure) - new Date(a.date_heure));
    
    if (articles.length === 0) {
      throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ù„Ø§Øª Ù…ØªØ§Ø­Ø©');
    }
    
    displayArticles();
    updateStats();
    hideLoading();
    
  } catch (error) {
    showError(error.message);
  }
}

function displayArticles() {
  elements.container.innerHTML = '';
  
  articles.forEach((article, index) => {
    const card = createArticleCard(article, index);
    elements.container.appendChild(card);
  });
  
  elements.container.style.display = 'grid';
  
  // Stagger animation
  document.querySelectorAll('.article-card').forEach((card, i) => {
    card.style.animationDelay = `${i * 0.05}s`;
  });
}

function createArticleCard(article, index) {
  const card = document.createElement('article');
  card.className = 'article-card';
  
  const imageUrl = getImageUrl(article.image_brute);
  const date = formatDate(article.date_heure);
  const timeAgo = getTimeAgo(article.date_heure);
  const keywords = parseKeywords(article.mots_cles);
  const sentimentClass = getSentimentClass(article.sentiment);
  
  card.innerHTML = `
    <div class="article-image-wrapper">
      ${imageUrl ? 
        `<img src="${imageUrl}" class="article-image" alt="${article.titre}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'image-placeholder\\'>ğŸ“°</div>'">` :
        `<div class="image-placeholder">ğŸ“°</div>`
      }
      
      <div class="badges">
        <span class="badge badge-date">ğŸ“… ${date}</span>
        ${article.theme ? `<span class="badge badge-theme">ğŸ·ï¸ ${article.theme}</span>` : ''}
        ${article.langue ? `<span class="badge badge-lang">${article.langue}</span>` : ''}
      </div>
      
      ${timeAgo ? `<div class="time-ago">${timeAgo}</div>` : ''}
    </div>
    
    <div class="article-content">
      <h2 class="article-title">${escapeHtml(article.titre || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†')}</h2>
      
      <div class="article-meta">
        <span class="meta-item source">ğŸ“° ${article.source || 'Ù…ØµØ¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
        ${article.sentiment ? `
          <span class="sentiment ${sentimentClass}">
            ${getSentimentIcon(article.sentiment)} ${article.sentiment}
          </span>
        ` : ''}
      </div>
      
      ${keywords.length > 0 ? `
        <div class="keywords">
          ${keywords.map(k => `<span class="keyword">${escapeHtml(k)}</span>`).join('')}
        </div>
      ` : ''}
    </div>
  `;
  
  card.addEventListener('click', () => openArticle(article));
  
  return card;
}

function getImageUrl(filename) {
  if (!filename) return null;
  if (filename.startsWith('http')) return filename;
  return `${CONFIG.githubBase}${CONFIG.imagesPath}${filename}${CONFIG.rawSuffix}`;
}

function formatDate(dateString) {
  if (!dateString) return '--';
  const date = new Date(dateString);
  if (isNaN(date.getTime())) return '--';
  
  return date.toLocaleDateString('ar-MA', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });
}

function getTimeAgo(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  if (isNaN(date.getTime())) return '';
  
  const now = new Date();
  const diffMs = now - date;
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) {
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    if (diffHours === 0) {
      const diffMins = Math.floor(diffMs / (1000 * 60));
      return diffMins < 1 ? 'Ø§Ù„Ø¢Ù†' : `Ù…Ù†Ø° ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
    }
    return `Ù…Ù†Ø° ${diffHours} Ø³Ø§Ø¹Ø©`;
  }
  if (diffDays === 1) return 'Ø£Ù…Ø³';
  if (diffDays < 7) return `Ù…Ù†Ø° ${diffDays} Ø£ÙŠØ§Ù…`;
  if (diffDays < 30) return `Ù…Ù†Ø° ${Math.floor(diffDays / 7)} Ø£Ø³Ø§Ø¨ÙŠØ¹`;
  return '';
}

function parseKeywords(keywordsString) {
  if (!keywordsString) return [];
  return keywordsString
    .split(/[,ØŒ]/)
    .map(k => k.trim())
    .filter(k => k.length > 0)
    .slice(0, 5); // Limit to 5 keywords
}

function getSentimentClass(sentiment) {
  if (!sentiment) return 'sentiment-neutral';
  const s = sentiment.toLowerCase();
  if (s.includes('positif') || s.includes('Ø¥ÙŠØ¬Ø§Ø¨ÙŠ')) return 'sentiment-positive';
  if (s.includes('negatif') || s.includes('Ø³Ù„Ø¨ÙŠ')) return 'sentiment-negative';
  return 'sentiment-neutral';
}

function getSentimentIcon(sentiment) {
  if (!sentiment) return 'âšª';
  const s = sentiment.toLowerCase();
  if (s.includes('positif') || s.includes('Ø¥ÙŠØ¬Ø§Ø¨ÙŠ')) return 'ğŸ˜Š';
  if (s.includes('negatif') || s.includes('Ø³Ù„Ø¨ÙŠ')) return 'ğŸ˜”';
  return 'ğŸ˜';
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function openArticle(article) {
  currentArticle = article;
  elements.overlayTitle.textContent = article.titre || 'Ø§Ù„Ù…Ù‚Ø§Ù„';
  elements.overlayFrame.src = article.url || '#';
  elements.overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeOverlay() {
  elements.overlay.classList.remove('active');
  elements.overlayFrame.src = '';
  document.body.style.overflow = '';
  currentArticle = null;
}

function updateStats() {
  elements.totalCount.textContent = articles.length.toLocaleString('ar-MA');
  elements.lastUpdate.textContent = new Date().toLocaleTimeString('ar-MA', {
    hour: '2-digit',
    minute: '2-digit'
  });
}

function showLoading() {
  elements.loading.style.display = 'flex';
  elements.container.style.display = 'none';
  elements.error.style.display = 'none';
}

function hideLoading() {
  elements.loading.style.display = 'none';
}

function showError(message) {
  elements.loading.style.display = 'none';
  elements.container.style.display = 'none';
  elements.error.style.display = 'block';
  elements.errorMessage.textContent = message;
}

// PDF Generation
async function generatePDF() {
  if (articles.length === 0) {
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ù„Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
    return;
  }
  
  elements.downloadBtn.disabled = true;
  const originalText = elements.downloadBtn.innerHTML;
  elements.downloadBtn.innerHTML = '<span>â³</span><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>';
  
  try {
    const content = createPDFContent();
    elements.pdfContainer.innerHTML = '';
    elements.pdfContainer.appendChild(content);
    elements.pdfContainer.style.display = 'block';
    
    await waitForImages(content);
    
    const options = {
      margin: [15, 15, 15, 15],
      filename: `Ù…Ø±Ø§Ø¬Ø¹Ø©_Ø§Ù„ØµØ­Ø§ÙØ©_${new Date().toISOString().split('T')[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        logging: false
      },
      jsPDF: {
        unit: 'mm',
        format: 'a4',
        orientation: 'portrait',
        compress: true
      }
    };
    
    await html2pdf().set(options).from(content).save();
    
  } catch (error) {
    console.error('PDF Error:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF');
  } finally {
    elements.pdfContainer.innerHTML = '';
    elements.pdfContainer.style.display = 'none';
    elements.downloadBtn.disabled = false;
    elements.downloadBtn.innerHTML = originalText;
  }
}

function createPDFContent() {
  const container = document.createElement('div');
  container.style.cssText = `
    font-family: 'Tajawal', sans-serif;
    direction: rtl;
    text-align: right;
    padding: 20px;
    background: white;
    color: #1e293b;
    line-height: 1.6;
  `;
  
  // Header
  const header = document.createElement('div');
  header.style.cssText = `
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 3px solid #3b82f6;
  `;
  
  header.innerHTML = `
    <h1 style="font-size: 28px; color: #1e293b; margin-bottom: 8px; font-weight: 900;">
      Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØµØ­Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
    </h1>
    <p style="font-size: 14px; color: #64748b; margin-bottom: 5px;">
      Revue de Presse Hebdomadaire
    </p>
    <p style="font-size: 12px; color: #94a3b8;">
      ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-MA')}
    </p>
    <p style="font-size: 12px; color: #3b82f6; font-weight: 700; margin-top: 10px;">
      Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª: ${articles.length}
    </p>
  `;
  
  container.appendChild(header);
  
  // Articles
  articles.forEach((article, index) => {
    const articleDiv = document.createElement('div');
    articleDiv.style.cssText = `
      margin-bottom: 25px;
      padding: 20px;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: #f8fafc;
      page-break-inside: avoid;
    `;
    
    const imageUrl = getImageUrl(article.image_brute);
    const date = formatDate(article.date_heure);
    const keywords = parseKeywords(article.mots_cles);
    
    articleDiv.innerHTML = `
      <div style="display: flex; gap: 15px; margin-bottom: 15px; ${index % 2 === 1 ? 'flex-direction: row-reverse;' : ''}">
        ${imageUrl ? `
          <div style="flex-shrink: 0; width: 120px; height: 80px; border-radius: 8px; overflow: hidden; background: #e2e8f0;">
            <img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'">
          </div>
        ` : ''}
        
        <div style="flex: 1;">
          <h2 style="font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 8px; line-height: 1.4;">
            ${index + 1}. ${escapeHtml(article.titre || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†')}
          </h2>
          
          <div style="font-size: 12px; color: #64748b; display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 8px;">
            <span><strong>Ø§Ù„Ù…ØµØ¯Ø±:</strong> ${escapeHtml(article.source || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')}</span>
            <span><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${date}</span>
            ${article.theme ? `<span><strong>Ø§Ù„ÙØ¦Ø©:</strong> ${escapeHtml(article.theme)}</span>` : ''}
            ${article.langue ? `<span><strong>Ø§Ù„Ù„ØºØ©:</strong> ${article.langue}</span>` : ''}
          </div>
          
          ${article.sentiment ? `
            <div style="font-size: 11px; margin-bottom: 8px;">
              <span style="
                padding: 3px 10px;
                border-radius: 12px;
                background: ${getSentimentClass(article.sentiment).includes('positive') ? '#d1fae5' : getSentimentClass(article.sentiment).includes('negative') ? '#fee2e2' : '#f1f5f9'};
                color: ${getSentimentClass(article.sentiment).includes('positive') ? '#059669' : getSentimentClass(article.sentiment).includes('negative') ? '#dc2626' : '#64748b'};
                font-weight: 600;
              ">
                ${getSentimentIcon(article.sentiment)} ${article.sentiment}
              </span>
            </div>
          ` : ''}
        </div>
      </div>
      
      ${keywords.length > 0 ? `
        <div style="display: flex; flex-wrap: wrap; gap: 6px; padding-top: 10px; border-top: 1px dashed #cbd5e1;">
          <span style="font-size: 11px; color: #94a3b8; font-weight: 600;">Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©:</span>
          ${keywords.map(k => `
            <span style="
              padding: 3px 10px;
              background: #3b82f6;
              color: white;
              font-size: 10px;
              border-radius: 10px;
            ">${escapeHtml(k)}</span>
          `).join('')}
        </div>
      ` : ''}
      
      ${article.url ? `
        <div style="margin-top: 10px; font-size: 10px; color: #3b82f6; word-break: break-all;">
          ğŸ”— ${article.url}
        </div>
      ` : ''}
    `;
    
    container.appendChild(articleDiv);
  });
  
  // Footer
  const footer = document.createElement('div');
  footer.style.cssText = `
    text-align: center;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
    font-size: 11px;
    color: #94a3b8;
  `;
  footer.innerHTML = `
    <p>Â© ${new Date().getFullYear()} Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØµØ­Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</p>
    <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
  `;
  container.appendChild(footer);
  
  return container;
}

function waitForImages(container) {
  return new Promise((resolve) => {
    const images = container.querySelectorAll('img');
    let loaded = 0;
    const total = images.length;
    
    if (total === 0) {
      setTimeout(resolve, 100);
      return;
    }
    
    const checkComplete = () => {
      loaded++;
      if (loaded >= total) {
        setTimeout(resolve, 300);
      }
    };
    
    images.forEach(img => {
      if (img.complete && img.naturalHeight !== 0) {
        checkComplete();
      } else {
        img.onload = checkComplete;
        img.onerror = checkComplete;
      }
    });
    
    // Timeout fallback
    setTimeout(resolve, 3000);
  });
}
</script>
</body>
</html>
