<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ØµØ­Ø§ÙØ© Ø§Ù„Ø°ÙƒÙŠØ© | Smart Press</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #001122;
            --accent: #cc0000;
            --bg: #f0f2f5;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            direction: rtl;
            color: #333;
            line-height: 1.6;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 1.25rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        #news-feed {
            max-width: 1200px;
            margin: 1.25rem auto;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: var(--white);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f5f5f5;
            display: block;
        }

        .card-content {
            padding: 1.25rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
            color: var(--primary);
            line-height: 1.4;
        }

        .card-meta {
            font-size: 0.85rem;
            color: #666;
            margin-top: auto;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 2rem 0;
            flex-wrap: wrap;
            padding: 0 1rem;
        }

        .page-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            min-width: 40px;
        }

        .page-btn:hover:not(:disabled) {
            background: var(--accent);
            transform: scale(1.05);
        }

        .page-btn.active {
            background: var(--accent);
            font-weight: bold;
        }

        .page-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .loader, .error-state, .empty-state {
            text-align: center;
            grid-column: 1/-1;
            padding: 3rem;
            font-size: 1.1rem;
            color: #666;
        }

        .error-state { color: var(--accent); }
        .empty-state { color: var(--primary); }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            header { font-size: 1.25rem; }
            #news-feed { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
            .card-title { font-size: 1rem; }
        }

        @media (max-width: 480px) {
            #news-feed { grid-template-columns: 1fr; }
            .page-btn { padding: 0.4rem 0.8rem; }
        }
    </style>
</head>
<body>
    <header>ğŸ“° Ø§Ù„ØµØ­Ø§ÙØ© Ø§Ù„Ø°ÙƒÙŠØ©</header>

    <div id="news-feed">
        <div class="loader">
            <div class="spinner"></div>
            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...
        </div>
    </div>

    <div class="pagination" id="pagination"></div>

    <script>
        const CONFIG = {
            // âœ… JSON URL - CORRECT avec timestamp pour Ã©viter le cache
            JSON_URL: 'data/data_fusionnee.json?t=' + Date.now(),
            
            // âœ… Images GitHub RAW
            IMAGE_URL: (id) => `https://raw.githubusercontent.com/marocnetmail/125/main/images/img05/${id}.jpg`,
            
            ITEMS_PER_PAGE: 12,
            DEFAULT_IMAGE: "https://via.placeholder.com/600x400/001122/FFFFFF?text=Smart+Press"
        };

        let allNews = [];
        let currentPage = 1;

        async function loadData() {
            try {
                console.log("ğŸ“¦ Chargement depuis:", CONFIG.JSON_URL);
                
                const response = await fetch(CONFIG.JSON_URL, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    cache: 'no-store' // DÃ©sactive le cache
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log("âœ… DonnÃ©es reÃ§ues:", data);

                // ğŸ“Š Extraction intelligente des donnÃ©es
                if (Array.isArray(data)) {
                    allNews = data;
                } else if (data && typeof data === 'object') {
                    // Chercher le tableau dans l'objet
                    allNews = data.news || data.articles || data.items || data.data || [];
                    
                    // Si toujours vide, prendre la premiÃ¨re propriÃ©tÃ© tableau
                    if (allNews.length === 0) {
                        for (let key in data) {
                            if (Array.isArray(data[key]) && data[key].length > 0) {
                                allNews = data[key];
                                console.log(`ğŸ“ Utilisation de la propriÃ©tÃ©: ${key}`);
                                break;
                            }
                        }
                    }
                }

                // ğŸ” Filtrer et normaliser
                allNews = allNews
                    .filter(item => item && item.id)
                    .map(item => ({
                        id: String(item.id).trim(),
                        title: item.titre || item.title || item.headline || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†",
                        date: item["date/heure"] || item.date || item.published || item.pubDate || "",
                        url: item.url || item.link || item.permalink || "#"
                    }));

                console.log(`âœ… ${allNews.length} articles valides chargÃ©s`);

                if (allNews.length === 0) {
                    throw new Error("âš ï¸ Aucun article avec ID trouvÃ© dans le fichier JSON");
                }

                renderPage(1);
            } catch (error) {
                console.error("âŒ Erreur de chargement:", error);
                
                const container = document.getElementById("news-feed");
                container.innerHTML = `
                    <div class="error-state">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">âŒ</div>
                        <div style="font-size: 1.3rem; margin-bottom: 1rem;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</div>
                        <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px; margin: 1rem auto; max-width: 500px; text-align: right; direction: ltr; font-family: monospace;">
                            <div style="margin-bottom: 0.5rem;">ğŸ”— ${CONFIG.JSON_URL}</div>
                            <div style="color: #856404;">${error.message}</div>
                        </div>
                        <div style="margin-top: 2rem;">
                            <button onclick="location.reload()" style="background: var(--accent); color: white; border: none; padding: 0.75rem 2rem; border-radius: 5px; cursor: pointer; font-size: 1rem; margin: 0 0.5rem;">
                                ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                            </button>
                            <button onclick="window.location.href='data/datajson.json'" style="background: var(--primary); color: white; border: none; padding: 0.75rem 2rem; border-radius: 5px; cursor: pointer; font-size: 1rem; margin: 0 0.5rem;">
                                ğŸ“ VÃ©rifier le fichier
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function renderPage(page) {
            if (!allNews.length) return;

            currentPage = page;
            const container = document.getElementById("news-feed");
            const paginationContainer = document.getElementById("pagination");
            
            container.innerHTML = "";
            
            const start = (page - 1) * CONFIG.ITEMS_PER_PAGE;
            const end = start + CONFIG.ITEMS_PER_PAGE;
            const pageItems = allNews.slice(start, end);

            pageItems.forEach(item => {
                const card = document.createElement("article");
                card.className = "card";
                
                // URL de l'image GitHub RAW
                const imgUrl = CONFIG.IMAGE_URL(item.id);

                // Image avec gestion d'erreur
                const img = document.createElement("img");
                img.className = "card-img";
                img.loading = "lazy";
                img.alt = item.title;
                img.src = imgUrl;
                
                // Fallback si image non trouvÃ©e
                img.onerror = function() {
                    console.log(`ğŸ–¼ï¸ Image non trouvÃ©e: ${item.id}`);
                    this.onerror = null;
                    this.src = CONFIG.DEFAULT_IMAGE;
                };

                // Contenu
                const content = document.createElement("div");
                content.className = "card-content";
                content.innerHTML = `
                    <div class="card-title">${escapeHTML(item.title)}</div>
                    <div class="card-meta">
                        ğŸ“… ${escapeHTML(item.date) || "Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…ØªÙˆÙØ±"}
                        ${item.id ? `<span style="margin-right: 0.5rem; color: #999;">ğŸ†” ${escapeHTML(item.id)}</span>` : ''}
                    </div>
                `;

                card.appendChild(img);
                card.appendChild(content);

                // Lien vers l'article complet
                if (item.url && item.url !== "#") {
                    card.onclick = () => window.open(item.url, '_blank', 'noopener,noreferrer');
                    card.style.cursor = "pointer";
                }

                container.appendChild(card);
            });

            renderPaginationUI();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderPaginationUI() {
            const paginationContainer = document.getElementById("pagination");
            paginationContainer.innerHTML = "";
            
            const totalPages = Math.ceil(allNews.length / CONFIG.ITEMS_PER_PAGE);

            if (totalPages <= 1) return;

            // Bouton prÃ©cÃ©dent
            const prevBtn = document.createElement("button");
            prevBtn.innerText = "â† Ø§Ù„Ø³Ø§Ø¨Ù‚";
            prevBtn.className = "page-btn";
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => renderPage(currentPage - 1);
            paginationContainer.appendChild(prevBtn);

            // NumÃ©ros de page
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);

            if (startPage > 1) {
                addPageButton(1);
                if (startPage > 2) addEllipsis();
            }

            for (let i = startPage; i <= endPage; i++) {
                addPageButton(i);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) addEllipsis();
                addPageButton(totalPages);
            }

            function addPageButton(pageNum) {
                const btn = document.createElement("button");
                btn.innerText = pageNum;
                btn.className = `page-btn ${pageNum === currentPage ? 'active' : ''}`;
                btn.onclick = () => renderPage(pageNum);
                paginationContainer.appendChild(btn);
            }

            function addEllipsis() {
                const span = document.createElement("span");
                span.innerText = "...";
                span.style.padding = "0 0.5rem";
                span.style.color = "#666";
                paginationContainer.appendChild(span);
            }

            // Bouton suivant
            const nextBtn = document.createElement("button");
            nextBtn.innerText = "Ø§Ù„ØªØ§Ù„ÙŠ â†’";
            nextBtn.className = "page-btn";
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => renderPage(currentPage + 1);
            paginationContainer.appendChild(nextBtn);
        }

        function escapeHTML(text) {
            if (!text) return "";
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
