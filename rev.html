<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#001122">
    <meta name="description" content="مراجعة الصحافة الأسبوعية - النسخة المحدثة">
    <title>مراجعة الصحافة الأسبوعية</title>
    
    <link rel="icon" type="image/png" href="images1/00011.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d5cb6;
            --background: #001122;
            --card-bg: #001a44;
            --text: #ffffff;
            --text-secondary: #cccccc;
            --accent-1: #FF6B6B;
            --accent-2: #4ECDC4;
            --accent-3: #FFD166;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Header Styles */
        .app-header {
            background: #001122;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .main-title img {
            max-width: 200px;
            height: auto;
            display: block;
            margin: 0 auto 15px;
        }

        /* Search & Filters */
        .filters-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 800px;
            margin: 0 auto;
        }

        .search-wrapper {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.08);
            border-radius: var(--radius);
            padding: 5px 15px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: var(--transition);
        }

        .search-wrapper:focus-within {
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--primary);
        }

        #search-input {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 16px;
            outline: none;
            text-align: right;
        }

        .date-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .date-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }

        .date-label {
            font-size: 0.75rem;
            color: var(--accent-3);
            margin-bottom: 4px;
        }

        .date-input {
            background: transparent;
            border: none;
            color: white;
            font-family: inherit;
            outline: none;
        }

        /* Presets & Actions */
        .period-presets {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 15px 0;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .preset-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: var(--transition);
        }

        .preset-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn {
            padding: 12px;
            border-radius: var(--radius);
            border: none;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
            transition: var(--transition);
        }

        .btn-clear { background: #555; }
        .btn-pdf { background: #2e7d32; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Articles Grid */
        #articles-container {
            padding: 15px;
            display: grid;
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .article-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
        }

        .article-card:hover {
            transform: translateY(-5px);
        }

        .article-image-container {
            position: relative;
            height: 200px;
            background: #000;
        }

        .article-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .title-overlay {
            position: absolute;
            bottom: 0;
            right: 0;
            left: 0;
            padding: 20px 15px 15px;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
        }

        .article-main-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .metadata-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* Overlay */
        #article-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
        }

        .overlay-content {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .overlay-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
        }

        .close-btn {
            background: var(--accent-1);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }

        /* Stats Bar */
        .stats-bar {
            padding: 10px 15px;
            background: rgba(255,255,255,0.03);
            font-size: 0.85rem;
            text-align: center;
            color: var(--accent-2);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 14px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        .page-btn.active {
            background: var(--primary);
        }

        @media (min-width: 768px) {
            #articles-container { grid-template-columns: repeat(2, 1fr); }
            .date-filters { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

<header class="app-header">
    <div class="main-title">
        <img src="images/title.png" alt="Logo">
    </div>
   
    <div class="filters-container">
        <div class="search-wrapper">
            <input type="text" id="search-input" placeholder="بحث في العناوين أو المصادر..." autocomplete="off">
            <span id="clear-search" style="cursor:pointer; padding: 0 10px;">✕</span>
        </div>
     
        <div class="date-filters">
            <div class="date-group">
                <span class="date-label">من تاريخ</span>
                <input type="date" id="start-date" class="date-input">
            </div>
            <div class="date-group">
                <span class="date-label">إلى تاريخ</span>
                <input type="date" id="end-date" class="date-input">
            </div>
        </div>

        <div class="period-presets">
            <button class="preset-btn" data-period="week">أسبوع</button>
            <button class="preset-btn" data-period="biweekly">15 يوم</button>
            <button class="preset-btn" data-period="month">شهر</button>
        </div>
  
        <div class="action-buttons">
            <button class="btn btn-clear" id="clear-filters">مسح الكل</button>
            <button class="btn btn-pdf" id="download-pdf-btn">تحميل PDF</button>
        </div>
    </div>
</header>

<div class="stats-bar" id="stats-bar">
    جاري تحميل البيانات...
</div>

<main id="articles-container">
    </main>

<div class="pagination" id="pagination-container"></div>

<div id="article-overlay">
    <div class="overlay-content">
        <div class="overlay-header">
            <span id="overlay-title" style="font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:70%;"></span>
            <button class="close-btn" id="close-overlay">×</button>
        </div>
        <iframe id="article-frame" style="flex:1; border:none; background:white;"></iframe>
    </div>
</div>

<div id="pdf-temp-container" style="display:none;"></div>

<script>
/**
 * CONFIGURATION
 * تم تعديل المسارات لتتوافق مع طلبك ومع GitHub
 */
const CONFIG = {
    jsonUrl: 'data/data_fusionnee.json?v=' + Date.now(),
    logosUrl: 'data/logo_media.json',
    imagesBasePath: 'images/img05/',
    articlesPerPage: 12
};

// Global State
let appState = {
    allArticles: [],
    filteredArticles: [],
    currentPage: 1,
    mediaLogos: {}
};

// DOM Elements
const elements = {
    container: document.getElementById('articles-container'),
    searchInput: document.getElementById('search-input'),
    startDate: document.getElementById('start-date'),
    endDate: document.getElementById('end-date'),
    statsBar: document.getElementById('stats-bar'),
    pagination: document.getElementById('pagination-container'),
    overlay: document.getElementById('article-overlay'),
    frame: document.getElementById('article-frame'),
    pdfBtn: document.getElementById('download-pdf-btn')
};

/**
 * INITIALIZATION
 */
async function init() {
    setupEventListeners();
    await loadLogos();
    await loadArticles();
    setInitialPeriod();
}

async function loadLogos() {
    try {
        const res = await fetch(CONFIG.logosUrl);
        const data = await res.json();
        data.forEach(item => {
            appState.mediaLogos[item.domaine?.toLowerCase()] = item.url;
        });
    } catch (e) { console.warn("Logos not loaded"); }
}

async function loadArticles() {
    try {
        const res = await fetch(CONFIG.jsonUrl);
        const data = await res.json();
        
        // معالجة البيانات وتنظيفها
        appState.allArticles = data
            .filter(a => a.visible === true || a.visible === "true")
            .map(a => ({
                ...a,
                parsedDate: parseDate(a.date_heure)
            }))
            .sort((a, b) => b.parsedDate - a.parsedDate);
            
        filterArticles();
    } catch (e) {
        elements.statsBar.textContent = "خطأ في تحميل البيانات";
        console.error(e);
    }
}

/**
 * LOGIC FUNCTIONS
 */
function parseDate(dateStr) {
    if (!dateStr) return new Date(0);
    // Format expected: "DD/MM/YYYY HH:mm"
    const parts = dateStr.split(' ');
    const dateParts = parts[0].split('/');
    return new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
}

function filterArticles() {
    const query = elements.searchInput.value.toLowerCase();
    const start = elements.startDate.value ? new Date(elements.startDate.value) : null;
    const end = elements.endDate.value ? new Date(elements.endDate.value) : null;
    if (end) end.setHours(23, 59, 59);

    appState.filteredArticles = appState.allArticles.filter(a => {
        const matchesSearch = !query || 
            a.titre?.toLowerCase().includes(query) || 
            a.source?.toLowerCase().includes(query) ||
            a.theme?.toLowerCase().includes(query);
            
        const matchesDate = (!start || a.parsedDate >= start) && 
                            (!end || a.parsedDate <= end);
                            
        return matchesSearch && matchesDate;
    });

    appState.currentPage = 1;
    render();
}

function render() {
    const startIdx = (appState.currentPage - 1) * CONFIG.articlesPerPage;
    const paginated = appState.filteredArticles.slice(startIdx, startIdx + CONFIG.articlesPerPage);
    
    elements.container.innerHTML = paginated.map(article => `
        <article class="article-card" onclick="openArticle('${article.url}', '${article.titre.replace(/'/g, "&apos;")}')">
            <div class="article-image-container">
                <img class="article-image" src="${getImgUrl(article.image_brute)}" 
                     onerror="this.src='https://via.placeholder.com/400x200?text=No+Image'" loading="lazy">
                <span class="metadata-badge">${article.source || 'المصدر'}</span>
                <div class="title-overlay">
                    <h2 class="article-main-title">${article.titre}</h2>
                    <div style="font-size:0.8rem; color:var(--accent-2)">${article.date_heure.split(' ')[0]} | ${article.theme || ''}</div>
                </div>
            </div>
        </article>
    `).join('');

    elements.statsBar.textContent = `تم العثور على ${appState.filteredArticles.length} مقال`;
    renderPagination();
}

function getImgUrl(imgName) {
    if (!imgName) return '';
    if (imgName.startsWith('http')) return imgName;
    return CONFIG.imagesBasePath + imgName;
}

function renderPagination() {
    const totalPages = Math.ceil(appState.filteredArticles.length / CONFIG.articlesPerPage);
    if (totalPages <= 1) {
        elements.pagination.innerHTML = '';
        return;
    }

    let html = '';
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= appState.currentPage - 1 && i <= appState.currentPage + 1)) {
            html += `<button class="page-btn ${i === appState.currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
        } else if (i === appState.currentPage - 2 || i === appState.currentPage + 2) {
            html += `<span>...</span>`;
        }
    }
    elements.pagination.innerHTML = html;
}

/**
 * ACTIONS
 */
window.goToPage = (page) => {
    appState.currentPage = page;
    render();
    window.scrollTo({ top: 0, behavior: 'smooth' });
};

window.openArticle = (url, title) => {
    document.getElementById('overlay-title').textContent = title;
    elements.frame.src = url;
    elements.overlay.style.display = 'block';
    document.body.style.overflow = 'hidden';
};

function setupEventListeners() {
    elements.searchInput.addEventListener('input', debounce(filterArticles, 300));
    
    document.getElementById('clear-search').onclick = () => {
        elements.searchInput.value = '';
        filterArticles();
    };

    elements.startDate.onchange = filterArticles;
    elements.endDate.onchange = filterArticles;

    document.getElementById('clear-filters').onclick = () => {
        elements.searchInput.value = '';
        setInitialPeriod();
    };

    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            setPeriod(btn.dataset.period);
        };
    });

    document.getElementById('close-overlay').onclick = () => {
        elements.overlay.style.display = 'none';
        elements.frame.src = '';
        document.body.style.overflow = 'auto';
    };

    elements.pdfBtn.onclick = generatePDF;
}

function setInitialPeriod() {
    const btn = document.querySelector('[data-period="week"]');
    btn.classList.add('active');
    setPeriod('week');
}

function setPeriod(period) {
    const end = new Date();
    const start = new Date();
    if (period === 'week') start.setDate(end.getDate() - 7);
    else if (period === 'biweekly') start.setDate(end.getDate() - 15);
    else if (period === 'month') start.setDate(end.getDate() - 30);

    elements.endDate.valueAsDate = end;
    elements.startDate.valueAsDate = start;
    filterArticles();
}

/**
 * PDF GENERATION (ROBUST)
 */
async function generatePDF() {
    const { jsPDF } = window.jspdf ? window : { jsPDF: null };
    elements.pdfBtn.disabled = true;
    elements.pdfBtn.textContent = "جاري التحضير...";

    const content = document.createElement('div');
    content.style.padding = '20px';
    content.style.direction = 'rtl';
    content.style.fontFamily = 'Tajawal';

    content.innerHTML = `
        <h1 style="text-align:center; color:#1a73e8;">مراجعة الصحافة</h1>
        <p style="text-align:center;">الفترة: ${elements.startDate.value} إلى ${elements.endDate.value}</p>
        <hr>
        ${appState.filteredArticles.map((a, i) => `
            <div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 style="margin:0;">${i+1}. ${a.titre}</h3>
                <p style="font-size:12px; color:#666; margin:5px 0;">المصدر: ${a.source} | التاريخ: ${a.date_heure}</p>
                <p style="font-size:11px; color:blue;">${a.url}</p>
            </div>
        `).join('')}
    `;

    const opt = {
        margin: 10,
        filename: `Press_Review_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    try {
        await html2pdf().set(opt).from(content).save();
    } catch (e) {
        alert("حدث خطأ أثناء توليد PDF");
    } finally {
        elements.pdfBtn.disabled = false;
        elements.pdfBtn.textContent = "تحميل PDF";
    }
}

function debounce(func, wait) {
    let timeout;
    return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
    };
}

// Start the App
init();
</script>

</body>
</html>
